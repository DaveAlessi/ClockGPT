{
  "fixed_code": "const express = require('express');\nconst session = require('express-session');\nconst multer = require('multer');\nconst path = require('path');\nconst fs = require('fs');\nconst bcrypt = require('bcrypt');\nconst sqlite3 = require('sqlite3').verbose();\n\nconst app = express();\nconst PORT = 3000;\n\n// Configure file upload storage \nconst storage = multer.diskStorage({\n  destination: (req, file, cb) => {\n    cb(null, 'public/images/');\n  },\n  filename: (req, file, cb) => {\n    const uniqueName = Date.now() + '-' + Math.round(Math.random() * 1E9) + path.extname(file.originalname);\n    cb(null, uniqueName);\n  }\n});\n\nconst upload = multer({ storage: storage });\n\n// Middleware \napp.use(express.static('public'));\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\napp.use(session({\n  secret: 'timezone-test-secret-key',\n  resave: false,\n  saveUninitialized: true,\n  cookie: {\n    secure: process.env.NODE_ENV === 'production', // true if using HTTPS in production\n    httpOnly: true,\n    sameSite: 'lax'\n  }\n}));\n\n// Simple CSRF protection using Origin/Referer checks for state-changing requests\nfunction csrfProtection(req, res, next) {\n  if (['GET', 'HEAD', 'OPTIONS'].includes(req.method)) {\n    return next();\n  }\n  const origin = req.headers.origin;\n  const referer = req.headers.referer;\n  const expectedOrigin = `${req.protocol}://${req.get('host')}`;\n\n  if ((origin && origin === expectedOrigin) || (referer && referer.startsWith(expectedOrigin))) {\n    return next();\n  }\n  return res.status(403).json({ error: 'CSRF validation failed' });\n}\n\napp.use(csrfProtection);\n\n// Database setup\nconst db = new sqlite3.Database('./users.db', (err) => {\n    if (err) {\n        console.error('Error opening database', err);\n    } else {\n        console.log('Database connected');\n        // Create users table\n        db.run(`CREATE TABLE IF NOT EXISTS users (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            username TEXT UNIQUE NOT NULL,\n            password_hash TEXT NOT NULL,\n            name TEXT,\n            timezone TEXT,\n            profile_picture TEXT,\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n        )`);\n    }\n});\n\n// Routes\napp.get('/', (req, res) => {\n    res.sendFile(path.join(__dirname, 'views', 'landing.html'));\n});\n\napp.get('/signin', (req, res) => {\n    res.sendFile(path.join(__dirname, 'views', 'signin.html'));\n});\n\napp.get('/registration', (req, res) => {\n    res.sendFile(path.join(__dirname, 'views', 'registration.html'));\n});\n\napp.get('/profile', (req, res) => {\n    if (!req.session.userId) {\n        return res.redirect('/signin');\n    }\n    res.sendFile(path.join(__dirname, 'views', 'profile.html'));\n});\n\n// Registration API\napp.post('/api/registration', async (req, res) => {\n    const { username, password, timezone } = req.body;\n    \n    try {\n        const passwordHash = await bcrypt.hash(password, 10);\n        \n        db.run(\n            'INSERT INTO users (username, password_hash, timezone) VALUES (?, ?, ?)',\n            [username, passwordHash, timezone],\n            function(err) {\n                if (err) {\n                    if (err.message.includes('UNIQUE')) {\n                        return res.status(400).json({ error: 'Username already exists' });\n                    }\n                    return res.status(500).json({ error: 'Registration failed' });\n                }\n                res.json({ success: true, userId: this.lastID });\n            }\n        );\n    } catch (error) {\n        console.error('Error:', error);\n        res.status(500).json({ error: 'Registration failed' });\n    }\n});\n\n// Login API\napp.post('/api/login', async (req, res) => {\n    const { username, password } = req.body;\n    \n    db.get('SELECT * FROM users WHERE username = ?', [username], async (err, user) => {\n        if (err) {\n            return res.status(500).json({ error: 'Login failed' });\n        }\n        \n        if (!user) {\n            return res.status(401).json({ error: 'Invalid username or password' });\n        }\n        \n        try {\n            const match = await bcrypt.compare(password, user.password_hash);\n            if (!match) {\n                return res.status(401).json({ error: 'Invalid username or password' });\n            }\n            \n            req.session.userId = user.id;\n            res.json({ success: true });\n        } catch (error) {\n            res.status(500).json({ error: 'Login failed' });\n        }\n    });\n});\n\n// Get user data\napp.get('/api/user', (req, res) => {\n    if (!req.session.userId) {\n        return res.status(401).json({ error: 'Not authenticated' });\n    }\n    \n    db.get('SELECT id, username, name, timezone, profile_picture FROM users WHERE id = ?', \n        [req.session.userId], \n        (err, user) => {\n            if (err || !user) {\n                return res.status(404).json({ error: 'User not found' });\n            }\n            res.json(user);\n        }\n    );\n});\n\n// Update user profile\napp.post('/api/user/update', (req, res) => {\n    if (!req.session.userId) {\n        return res.status(401).json({ error: 'Not authenticated' });\n    }\n    \n    const { name, timezone } = req.body;\n    \n    db.run(\n        'UPDATE users SET name = ?, timezone = ? WHERE id = ?',\n        [name, timezone, req.session.userId],\n        (err) => {\n            if (err) {\n                return res.status(500).json({ error: 'Update failed' });\n            }\n            res.json({ success: true });\n        }\n    );\n});\n\n// Upload profile picture\napp.post('/api/user/upload-picture', upload.single('profilePicture'), (req, res) => {\n    if (!req.session.userId) {\n        return res.status(401).json({ error: 'Not authenticated' });\n    }\n    \n    if (!req.file) {\n        return res.status(400).json({ error: 'No file uploaded' });\n    }\n    \n    const picturePath = '/images/' + req.file.filename;\n    \n    // Get old picture path to delete it\n    db.get('SELECT profile_picture FROM users WHERE id = ?', [req.session.userId], (err, user) => {\n        if (user && user.profile_picture) {\n            const oldPath = path.join(__dirname, 'public', user.profile_picture);\n            if (fs.existsSync(oldPath)) {\n                fs.unlinkSync(oldPath);\n            }\n        }\n        \n        // Update database with new picture\n        db.run(\n            'UPDATE users SET profile_picture = ? WHERE id = ?',\n            [picturePath, req.session.userId],\n            (err) => {\n                if (err) {\n                    return res.status(500).json({ error: 'Upload failed' });\n                }\n                res.json({ success: true, profilePicture: picturePath });\n            }\n        );\n    });\n});\n\n// Logout\napp.post('/logout', (req, res) => {\n    req.session.destroy(() => {\n      res.json({ success: true });\n    });\n});\n\n// Start server\napp.listen(PORT, () => {\n  console.log(`\\nğŸŒ Timezone Test Application Running!`);\n  console.log(`ğŸ“ Local URL: http://localhost:${PORT}`);\n  console.log(`\\nPress Ctrl+C to stop the server.\\